version: '3.8'

services:
  # Load Generator - Traffic generation and orchestration
  load-generator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: load-generator
    environment:
      - SERVICE_NAME=load-generator
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=load-generator
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
      - PRODUCT_CATALOG_URL=http://product-catalog:8014
      - CHECKOUT_URL=http://checkout:8016
      - CART_URL=http://cart:8013
      - DEMO_MODE=${DEMO_MODE:-normal}
    command: python services/load_generator.py
    ports:
      - "8010:8010"
    networks:
      - ecommerce
    restart: unless-stopped

  # Product Catalog - Product search with PostgreSQL
  product-catalog:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: product-catalog
    environment:
      - SERVICE_NAME=product-catalog
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=product-catalog
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
      - DB_HOST=${POSTGRES_HOST:-postgresql-primary}
      - DB_PORT=${POSTGRES_PORT:-5432}
      - DB_NAME=${POSTGRES_DB:-ecommerce}
      - DB_USER=${POSTGRES_USER:-ecommerce_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-ecommerce_password}
      - DB_MAX_CONNECTIONS=${DB_MAX_CONNECTIONS:-100}
      - DEMO_MODE=${DEMO_MODE:-normal}
    command: python services/product_catalog_service.py
    ports:
      - "8014:8014"
    depends_on:
      - postgresql-primary
    networks:
      - ecommerce
    restart: unless-stopped

  # Checkout - Payment processing
  checkout:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: checkout
    environment:
      - SERVICE_NAME=checkout
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=checkout
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
      - DB_HOST=${POSTGRES_HOST:-postgresql-primary}
      - DB_PORT=${POSTGRES_PORT:-5432}
      - DB_NAME=${POSTGRES_DB:-ecommerce}
      - DB_USER=${POSTGRES_USER:-ecommerce_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-ecommerce_password}
      - DB_MAX_CONNECTIONS=${DB_MAX_CONNECTIONS:-100}
      - DEMO_MODE=${DEMO_MODE:-normal}
    command: python services/checkout_service.py
    ports:
      - "8016:8016"
    depends_on:
      - postgresql-primary
    networks:
      - ecommerce
    restart: unless-stopped

  # Cart - Shopping cart with Redis
  cart:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: cart
    environment:
      - SERVICE_NAME=cart
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=cart
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    command: python services/cart_service.py
    ports:
      - "8013:8013"
    depends_on:
      - redis
    networks:
      - ecommerce
    restart: unless-stopped

  # Recommendation - Product recommendations (rule-based)
  recommendation:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: recommendation
    environment:
      - SERVICE_NAME=recommendation
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=recommendation
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
      - PRODUCT_CATALOG_URL=http://product-catalog:8014
    command: python services/recommendation_service.py
    ports:
      - "8011:8011"
    depends_on:
      - product-catalog
    networks:
      - ecommerce
    restart: unless-stopped

  # Currency - Currency conversion
  currency:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: currency
    environment:
      - SERVICE_NAME=currency
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=currency
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
    command: python services/currency_service.py
    ports:
      - "8018:8018"
    networks:
      - ecommerce
    restart: unless-stopped

  # Shipping - Shipping calculations
  shipping:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: shipping
    environment:
      - SERVICE_NAME=shipping
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=shipping
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
    command: python services/shipping_service.py
    ports:
      - "8019:8019"
    networks:
      - ecommerce
    restart: unless-stopped

  # Ad Service - Advertisement service
  ad:
    build:
      context: ..
      dockerfile: docker/Dockerfile.optimized
    container_name: ad-service
    environment:
      - SERVICE_NAME=ad-service
      - CX_TOKEN=${CX_TOKEN}
      - CX_ENDPOINT=${CX_ENDPOINT}
      - CX_APPLICATION_NAME=${CX_APPLICATION_NAME:-ecommerce-platform}
      - CX_SUBSYSTEM_NAME=ad-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://coralogix-opentelemetry-collector:4317}
    command: python services/ad_service.py
    ports:
      - "8017:8017"
    networks:
      - ecommerce
    restart: unless-stopped

  # PostgreSQL - Primary database
  postgresql-primary:
    image: postgres:16-alpine
    container_name: postgresql-primary
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce}
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ecommerce_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    ports:
      - "5432:5432"
    networks:
      - ecommerce
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ecommerce_user -d ecommerce"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis - Cache and session store
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ecommerce
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  ecommerce:
    driver: bridge
    name: ecommerce-network

volumes:
  postgres_data:
    name: ecommerce-postgres-data
  redis_data:
    name: ecommerce-redis-data
